// prisma/schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  USER
  GUARD
}

enum QRStatus {
  ACTIVE
  USED
  REVOKED
  EXPIRED
}

enum AccessType {
  ISSUE
  VALIDATE_ALLOW
  VALIDATE_DENY
}

enum AccessState {
  INSIDE
  OUTSIDE
}

enum QRKind {
  ENTRY
  EXIT
}

enum GuestState {
  OUTSIDE
  INSIDE
  COMPLETED
  OUTSIDE_AUTO  // Auto-expelled by system at 23:00 without manual exit scan
}

enum InstitutionalType {
  STUDENT
  TEACHER
  PAE
}

model User {
  id                Int                @id @default(autoincrement())
  boleta            String?            @unique
  name              String
  firstName         String?
  lastNameP         String?
  lastNameM         String?
  email             String             @unique  // Correo institucional (login)
  contactEmail       String?                // Correo de contacto (Notificaciones y Recuperación de contraseña)
  password          String
  role              String // ADMIN | GUARD | USER
  institutionalType InstitutionalType? //Solo aplica cuando role = USER
  photoUrl          String?   @db.VarChar(255)  // URL de la foto
  photoPublicId     String? @db.VarChar(255)
  lastActivityAt     DateTime?           @default(now()) // Cierrre de sesión por inactividad
  mustChangePassword Boolean             @default(false) // Verifica que el usuario debe cambiar la contraseña
  createdAt         DateTime           @default(now())
  isActive          Boolean            @default(true)
  accessState       AccessState        @default(OUTSIDE)
  enabled   Boolean @default(true)
  qrPasses      QRPass[]
  accessLogs    AccessLog[]     @relation("AccessByUser")
  guardLogs     AccessLog[]     @relation("ValidatedByGuard")
  accessEvents      AccessEvent[] @relation("AccessEventByUser")
  guardAccessEvents AccessEvent[] @relation("AccessEventByGuard")
  PasswordReset PasswordReset[]
  failedAttempts      Int       @default(0) // Contador de intentos fallidos
  lastFailedAttempt   DateTime  @default(now()) // Fecha del último intento fallido
  qrAttempts QRAttempt[] // Relación inversa a QRAttempt

  @@index([role])
  @@index([institutionalType])
}

model GuestVisit {
  id        Int        @id @default(autoincrement())
  firstName String
  lastNameP String
  lastNameM String?
  curp      String
  reason    String
  state     GuestState @default(OUTSIDE)
  createdAt DateTime   @default(now())
  expiresAt DateTime?
  expiredAtSystem DateTime?  // Timestamp when auto-expelled by system (for audit trail)

  passes QRPass[]
  logs   AccessLog[] @relation("AccessByGuest")
  accessEvents AccessEvent[] @relation("AccessEventByGuest")


  @@index([curp]) // << QUITAR @unique y dejarlo con índice normal
}

model QRPass {
  id        Int         @id @default(autoincrement())
  code      String      @unique
  userId    Int?
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  guestId   Int?
  guest     GuestVisit? @relation(fields: [guestId], references: [id])
  kind      QRKind
  status    QRStatus    @default(ACTIVE)
  expiresAt DateTime?
  createdAt DateTime    @default(now())
  logs      AccessLog[] @relation("QRPassLogs")
}

model AccessLog {
  id Int @id @default(autoincrement())

  userId Int?
  user   User? @relation("AccessByUser", fields: [userId], references: [id], onDelete: SetNull)

  guestId Int?
  guest   GuestVisit? @relation("AccessByGuest", fields: [guestId], references: [id])

  qrId Int?
  qr   QRPass? @relation("QRPassLogs", fields: [qrId], references: [id])

  kind   QRKind?
  action AccessType

  guardId Int?
  guard   User? @relation("ValidatedByGuard", fields: [guardId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
}

model PasswordReset {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  ip        String?   @db.VarChar(100)
  userAgent String?   @db.VarChar(300)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model QRAttempt {
  id           Int       @id @default(autoincrement())
  userId       Int
  attemptedAt  DateTime  @default(now())
  status       String    // Puede ser 'FAILED', 'SUCCESS', 'EXPIRED', etc.
  reason       String    // Razón del fallo, ej: 'QR Expirado', 'Intento Repetido'

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AccessEvent {
  id Int @id @default(autoincrement())

  // INSTITUTIONAL | GUEST
  subjectType String @db.VarChar(32)

  // Relación con usuario institucional
  userId Int?
  user   User? @relation("AccessEventByUser", fields: [userId], references: [id], onDelete: SetNull)

  // Relación con invitado
  guestId Int?
  guest   GuestVisit? @relation("AccessEventByGuest", fields: [guestId], references: [id])

  // Guardia que escaneó
  guardId Int?
  guard   User? @relation("AccessEventByGuard", fields: [guardId], references: [id], onDelete: SetNull)

  // ENTRY / EXIT (usa enum QRKind)
  accessType QRKind

  // ALLOWED | INVALID_QR | EXPIRED_QR | DENIED | ERROR ...
  result String @db.VarChar(32)

  // Mensaje corto: 'QR válido', 'QR no activo', etc.
  reason String @db.VarChar(255)

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
  @@index([guestId])
  @@index([guardId])
}
